<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>linuxabc</title>
  <meta name="author" content="alfie chan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="linuxabc"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="linuxabc" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">linuxabc</a></h1>
  <h2><a href="/">focus on security, network management and embeded OS</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-08T07:00:00.000Z"><a href="/2013/11/08/KVM-installation/">2013-11-8</a></time>
      
      
  
    <h1 class="title"><a href="/2013/11/08/KVM-installation/">在CentOS6.3中安装KVM</a></h1>
  

    </header>
    <div class="entry">
      
        <p>产品实验室服务器之前安装的是xen，kvm作为后起之秀也值得测试一下，于是将其中一台服务器格了，重装CentOS6和kvm。</p>
<p>服务器硬件：</p>
<ul>
<li>2 * Intel Xeon（支持虚拟化）</li>
<li>4 * broadcom千兆网卡</li>
<li>2 * SAS 300G硬盘</li>
</ul>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2013/11/08/KVM-installation/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-08-08T07:00:00.000Z"><a href="/2013/08/08/nginx-on-OpenBSD/">2013-08-8</a></time>
      
      
  
    <h1 class="title"><a href="/2013/08/08/nginx-on-OpenBSD/">nginx on OpenBSD</a></h1>
  

    </header>
    <div class="entry">
      
        <blockquote>
<p><strong>UPDATE</strong><br>原文针对OpenBSD4.9，现在已经是5.2了，有些内容重新做了修订。</p>
<p>Nginx(“engine x”)是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP 代理服务器 。Nginx 是由 Igor Sysoev 为俄罗斯访问量第二的Rambler.ru 站点开发的，它已经在该站点运行超过四年多了。Igor 将源代码以类BSD许可证的形式发布。自Nginx 发布四年来，Nginx已经因为它的稳定性、丰富的功能集、 示例配置文件和低系统资源的消耗而闻名了。目前国内各大门户网站已经部署了Nginx，如新浪、网易、腾讯等；国内几个重要的视频分享网站也部署了Nginx，如六房间、酷6等。</p>
</blockquote>
<p>经过几年的发展，nginx的市场占有率稳步上升，截至2013年，市场份额占有率为15.52%（netcraft统计），微软的IIS为16.69%。nginx不日即可超越IIS。</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2013/08/08/nginx-on-OpenBSD/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-04-26T08:00:00.000Z"><a href="/2013/04/26/openwrt-network-config/">2013-04-26</a></time>
      
      
  
    <h1 class="title"><a href="/2013/04/26/openwrt-network-config/">OpenWRT网络配置</a></h1>
  

    </header>
    <div class="entry">
      
        <h1>软硬件环境</h1>
<ul>
<li>硬件：Linksys WRT54G修改版，8M FLASH/64M RAM</li>
<li>OS：OpenWRT 12.09</li>
</ul>
<h1>需求</h1>
<ul>
<li>WAN口处于闲置状态，未连接任何网络</li>
<li>LAN IP: 192.168.44.1/24，wifi IP: 192.168.77.1/24</li>
<li>wifi与LAN这两个网段之间可互相访问</li>
<li>在wifi口启用DHCP服务</li>
<li>wifi处于AP mode，SSID为OpenWRT，启用WPS-PSK2认证</li>
</ul>
<h1>配置</h1>
<figure class="highlight"><pre><span class="preprocessor"># cat /etc/config/network</span>

config <span class="keyword">switch</span> <span class="string">'eth0'</span>
	option enable <span class="string">'1'</span>

config switch_vlan <span class="string">'eth0_0'</span>
	option device <span class="string">'eth0'</span>
	option vlan <span class="string">'0'</span>
	option ports <span class="string">'0 1 2 3 5'</span>

config switch_vlan <span class="string">'eth0_1'</span>
	option device <span class="string">'eth0'</span>
	option vlan <span class="string">'1'</span>
	option ports <span class="string">'4 5'</span>

config <span class="class"><span class="keyword">interface</span> '<span class="title">loopback</span>'
	<span class="title">option</span> <span class="title">ifname</span> '<span class="title">lo</span>'
	<span class="title">option</span> <span class="title">proto</span> '<span class="title">static</span>'
	<span class="title">option</span> <span class="title">ipaddr</span> '127.0.0.1'
	<span class="title">option</span> <span class="title">netmask</span> '255.0.0.0'

<span class="title">config</span> <span class="title">interface</span> '<span class="title">lan</span>'
	<span class="title">option</span> <span class="title">type</span> '<span class="title">bridge</span>'
	<span class="title">option</span> <span class="title">ifname</span> '<span class="title">eth0</span>.0'
	<span class="title">option</span> <span class="title">proto</span> '<span class="title">static</span>'
	<span class="title">option</span> <span class="title">netmask</span> '255.255.255.0'
	<span class="title">option</span> <span class="title">ipaddr</span> '192.168.44.1'

<span class="title">config</span> <span class="title">interface</span> '<span class="title">wan</span>'
	<span class="title">option</span> <span class="title">ifname</span> '<span class="title">eth0</span>.1'
	<span class="title">option</span> <span class="title">proto</span> '<span class="title">dhcp</span>'
	
<span class="title">config</span> <span class="title">interface</span> '<span class="title">wifi</span>'
	<span class="title">option</span> <span class="title">_orig_ifname</span> '<span class="title">radio0</span>.<span class="title">network1</span>'
	<span class="title">option</span> <span class="title">_orig_bridge</span> '<span class="title">false</span>'
	<span class="title">option</span> <span class="title">proto</span> '<span class="title">static</span>'
	<span class="title">option</span> <span class="title">ipaddr</span> '192.168.77.1'
	<span class="title">option</span> <span class="title">netmask</span> '255.255.255.0'
</pre></figure>

<p>注意：在openwrt官网中，wifi section缺乏<code>_orig_ifname</code>和<code>_orig_bridge</code>这两个参数，无法正常工作。</p>
<figure class="highlight"><pre># cat /etc/config/wireless 

config wifi-device <span class="comment">'radio0'</span>
	<span class="keyword">option</span> type <span class="comment">'mac80211'</span>
	<span class="keyword">option</span> channel <span class="comment">'11'</span>
	<span class="keyword">option</span> macaddr <span class="comment">'00:13:10:e5:bc:53'</span>
	<span class="keyword">option</span> hwmode <span class="comment">'11g'</span>
	<span class="keyword">option</span> txpower <span class="comment">'20'</span>
	<span class="keyword">option</span> country <span class="comment">'00'</span>

config wifi-iface
	<span class="keyword">option</span> device <span class="comment">'radio0'</span>
	<span class="keyword">option</span> network <span class="comment">'wifi'</span>
	<span class="keyword">option</span> mode <span class="comment">'ap'</span>
	<span class="keyword">option</span> encryption <span class="comment">'psk2'</span>
	<span class="keyword">option</span> key <span class="comment">'secret'</span>
	<span class="keyword">option</span> ssid <span class="comment">'OpenWRT'</span>
</pre></figure>

<figure class="highlight"><pre># cat /etc/config/dhcp

config dnsmasq
	<span class="keyword">option</span> domainneeded <span class="comment">'1'</span>
	<span class="keyword">option</span> boguspriv <span class="comment">'1'</span>
	<span class="keyword">option</span> localise_queries <span class="comment">'1'</span>
	<span class="keyword">option</span> rebind_protection <span class="comment">'1'</span>
	<span class="keyword">option</span> rebind_localhost <span class="comment">'1'</span>
	<span class="keyword">option</span> local <span class="comment">'/lan/'</span>
	<span class="keyword">option</span> domain <span class="comment">'lan'</span>
	<span class="keyword">option</span> expandhosts <span class="comment">'1'</span>
	<span class="keyword">option</span> authoritative <span class="comment">'1'</span>
	<span class="keyword">option</span> readethers <span class="comment">'1'</span>
	<span class="keyword">option</span> leasefile <span class="comment">'/tmp/dhcp.leases'</span>
	<span class="keyword">option</span> resolvfile <span class="comment">'/tmp/resolv.conf.auto'</span>
	list <span class="built_in">server</span> <span class="comment">'192.168.44.254'</span>

config dhcp <span class="comment">'lan'</span>
	<span class="keyword">option</span> interface <span class="comment">'lan'</span>
	<span class="keyword">option</span> ignore <span class="comment">'1'</span>

config dhcp <span class="comment">'wan'</span>
	<span class="keyword">option</span> interface <span class="comment">'wan'</span>
	<span class="keyword">option</span> ignore <span class="comment">'1'</span>

config dhcp <span class="comment">'wifi'</span>
	<span class="keyword">option</span> interface <span class="comment">'wifi'</span>
	<span class="keyword">option</span> start     <span class="comment">'100'</span>
	<span class="keyword">option</span> limit     <span class="comment">'20'</span>
	<span class="keyword">option</span> leasetime <span class="comment">'12h'</span>
</pre></figure>

<p>配置完成后</p>
<figure class="highlight"><pre><span class="preprocessor"># ifup wifi</span>
<span class="preprocessor"># /etc/init.d/dnsmasq restart</span>
</pre></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-04-04T08:00:00.000Z"><a href="/2013/04/04/RouterOS-study-notes/">2013-04-4</a></time>
      
      
  
    <h1 class="title"><a href="/2013/04/04/RouterOS-study-notes/">RouterOS学习笔记</a></h1>
  

    </header>
    <div class="entry">
      
        <p>2年前买了个RB493G，它是MikroTik当年出品的一款高性能企业级无线路由器，一直闲置着，落了不少灰。最近恰好要将大量数据从笔记本备份至ZFS存储，实在忍受不了LinkSYS WRT54G的无线速率，于是这两天把RB493G翻出来好好地玩了一把。</p>
<h1>interface</h1>
<p>RouterBOARD中的接口类型挺丰富，之前用得最多的就是千兆口和无线网卡，最近新出的RouterBOARD也带有SFP口了。当然，在RouterOS中接触最多的概念则是物理口和逻辑口。</p>
<h2>PPPoE client</h2>
<p>逻辑口，也就是拨号上网。注意哦，平时经常说ADSL拨号上网，实际上是两个概念，ADSL是物理层链路，拨号上网是通过PPPoE协议实现拨号、认证和计费。现在我用的是中国移动的家庭宽带，入户的直接就是一根网线，已经不再需要ADSL modern。</p>
<p>我将入户网线插入到RB493G的ether1中。Oracle的两根网线分别插入ether2和ether3，另外一根ether7置空，留作测试只用。</p>
<figure class="highlight"><pre>[admin@MikroTik] &gt; <span class="class"><span class="keyword">interface</span> <span class="title">pppoe</span>-<span class="title">client</span> <span class="title">print</span>
<span class="title">Flags</span>: <span class="title">X</span> - <span class="title">disabled</span>, <span class="title">R</span> - <span class="title">running</span> 
 0  <span class="title">R</span> <span class="title">name</span>="<span class="title">pppoe</span>-<span class="title">out1</span>" <span class="title">max</span>-<span class="title">mtu</span>=1480 <span class="title">max</span>-<span class="title">mru</span>=1480 <span class="title">mrru</span>=<span class="title">disabled</span> 
      <span class="title">interface</span>=<span class="title">ether1</span> <span class="title">user</span>="15904701233" <span class="title">password</span>="123123" 
      <span class="title">profile</span>=<span class="title">pppoe</span>-<span class="title">client</span>-<span class="title">default</span> <span class="title">service</span>-<span class="title">name</span>="" <span class="title">ac</span>-<span class="title">name</span>="" 
      <span class="title">add</span>-<span class="title">default</span>-<span class="title">route</span>=<span class="title">yes</span> <span class="title">dial</span>-<span class="title">on</span>-<span class="title">demand</span>=<span class="title">no</span> <span class="title">use</span>-<span class="title">peer</span>-<span class="title">dns</span>=<span class="title">yes</span> 
      <span class="title">allow</span>=<span class="title">pap</span>,<span class="title">chap</span>,<span class="title">mschap1</span>,<span class="title">mschap2</span>
</pre></figure>

<h2>ethernet</h2>
<p>毋庸置疑，物理口。</p>
<figure class="highlight"><pre>[admin@MikroTik] &gt; <span class="class"><span class="keyword">interface</span> <span class="title">ethernet</span> <span class="title">print</span>
<span class="title">Flags</span>: <span class="title">X</span> - <span class="title">disabled</span>, <span class="title">R</span> - <span class="title">running</span>, <span class="title">S</span> - <span class="title">slave</span> 
 #    <span class="title">NAME</span>        <span class="title">MTU</span> <span class="title">MAC</span>-<span class="title">ADDRESS</span>       <span class="title">ARP</span>        <span class="title">MASTER</span>-<span class="title">PORT</span>     <span class="title">SWITCH</span>    
 0 <span class="title">R</span>  <span class="title">ether1</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:87 <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch1</span>   
 1 <span class="title">RS</span> <span class="title">ether2</span>     1500 00:05:5<span class="title">D</span>:72:<span class="title">A5</span>:0<span class="title">D</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch2</span>   
 2 <span class="title">RS</span> <span class="title">ether3</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:89 <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch2</span>   
 3    <span class="title">ether4</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">A</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch2</span>   
 4    <span class="title">ether5</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">B</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch2</span>   
 5    <span class="title">ether6</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">C</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch1</span>   
 6 <span class="title">R</span>  <span class="title">ether7</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">D</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch1</span>   
 7    <span class="title">ether8</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">E</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch1</span>   
 8    <span class="title">ether9</span>     1500 00:0<span class="title">C</span>:42:<span class="title">A9</span>:<span class="title">AB</span>:8<span class="title">F</span> <span class="title">enabled</span>    <span class="title">none</span>            <span class="title">switch1</span>
</pre></figure>

<p>比较特别的地方是ether2和ether3均有一个<code>S</code>的标识，这是由于创建了一个bonding逻辑接口，下属口就是ether2和ether3。</p>
<h2>bonding</h2>
<p>逻辑口，包含了ether2和ether3，这两个口通过两根网线与solaris 11的两个网口相连，构建Link Aggregation。</p>
<figure class="highlight"><pre>[admin@MikroTik] &gt; <span class="class"><span class="keyword">interface</span> <span class="title">bonding</span> <span class="title">print</span>         
<span class="title">Flags</span>: <span class="title">X</span> - <span class="title">disabled</span>, <span class="title">R</span> - <span class="title">running</span> 
 0  <span class="title">R</span> <span class="title">name</span>="<span class="title">bonding1</span>" <span class="title">mtu</span>=1500 <span class="title">mac</span>-<span class="title">address</span>=00:05:5<span class="title">D</span>:72:<span class="title">A5</span>:0<span class="title">D</span> <span class="title">arp</span>=<span class="title">enabled</span> 
      <span class="title">slaves</span>=<span class="title">ether2</span>,<span class="title">ether3</span> <span class="title">mode</span>=802.3<span class="title">ad</span> <span class="title">primary</span>=<span class="title">none</span> <span class="title">link</span>-<span class="title">monitoring</span>=<span class="title">none</span> 
      <span class="title">arp</span>-<span class="title">interval</span>=100<span class="title">ms</span> <span class="title">arp</span>-<span class="title">ip</span>-<span class="title">targets</span>=192.168.172.20 <span class="title">mii</span>-<span class="title">interval</span>=100<span class="title">ms</span> 
      <span class="title">down</span>-<span class="title">delay</span>=0<span class="title">ms</span> <span class="title">up</span>-<span class="title">delay</span>=0<span class="title">ms</span> <span class="title">lacp</span>-<span class="title">rate</span>=30<span class="title">secs</span> 
      <span class="title">transmit</span>-<span class="title">hash</span>-<span class="title">policy</span>=<span class="title">layer</span>-2-<span class="title">and</span>-3
</pre></figure>

<p>RouterOS中对802.3ad的实现并不完整，尚未兼容layer-3-and-4这种策略，因此对端也只能设置成L2，L3或L2+L3。</p>
<h2>wireless</h2>
<p>物理口。此处用的无线网卡是R52n，可以实现2.4G和5G的802.11n。关键在于笔记本的无线网卡，很多仅支持2.4G的802.11n。</p>
<figure class="highlight"><pre>[admin<span class="property">@MikroTik</span>] /interface&gt; wireless print
Flags: X - disabled, R - running 
 <span class="number">0</span>  R name=<span class="string">"wlan1"</span> mtu=<span class="number">1500</span> mac-address=<span class="number">00</span>:<span class="number">0</span>C:<span class="number">42</span>:<span class="number">66</span>:<span class="number">45</span>:<span class="number">56</span> arp=enabled 
      interface-type=Atheros <span class="number">11</span>N mode=ap-bridge ssid=<span class="string">"RB493G"</span> 
      frequency=<span class="number">2412</span> band=<span class="number">2</span>ghz-b<span class="regexp">/g/</span>n channel-width=<span class="number">20</span>mhz scan-list=<span class="reserved">default</span> 
      wireless-protocol=<span class="number">802.11</span> wds-mode=disabled wds-<span class="reserved">default</span>-bridge=none 
      wds-ignore-ssid=<span class="literal">no</span> bridge-mode=enabled <span class="reserved">default</span>-authentication=<span class="literal">yes</span> 
      <span class="reserved">default</span>-forwarding=<span class="literal">yes</span> <span class="reserved">default</span>-ap-tx-limit=<span class="number">0</span> 
      <span class="reserved">default</span>-client-tx-limit=<span class="number">0</span> hide-ssid=<span class="literal">no</span> security-profile=<span class="reserved">default</span> 
      compression=<span class="literal">no</span>
</pre></figure>

<p>配置很复杂，还是通过winbox方便一些。即便是再忠诚的命令行拥护者也不能阻挡GUI的诱惑。</p>
<h1>IP address</h1>
<figure class="highlight"><pre><span class="title">[</span><span class="comment">admin@MikroTik</span>] <span class="comment">/ip</span>&gt; <span class="comment">address</span> <span class="comment">print</span>
<span class="comment">Flags:</span> <span class="comment">X</span> <span class="literal">-</span> <span class="comment">disabled</span>, <span class="comment">I</span> <span class="literal">-</span> <span class="comment">invalid</span>, <span class="comment">D</span> <span class="literal">-</span> <span class="comment">dynamic</span> 
 <span class="comment">#</span>   <span class="comment">ADDRESS</span>            <span class="comment">NETWORK</span>         <span class="comment">INTERFACE</span>                            
 <span class="comment">0</span>   <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">22</span>.<span class="comment">254/24</span>  <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">22</span>.<span class="comment">0</span>    <span class="comment">wlan1</span>                                
 <span class="comment">1</span>   <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">172</span>.<span class="comment">254/24</span> <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">172</span>.<span class="comment">0</span>   <span class="comment">bonding1</span>                             
 <span class="comment">2</span> <span class="comment">D</span> <span class="comment">183</span>.<span class="comment">254</span>.<span class="comment">43</span>.<span class="comment">236/32</span>  <span class="comment">183</span>.<span class="comment">254</span>.<span class="comment">0</span>.<span class="comment">1</span>     <span class="comment">pppoe</span>-<span class="comment">out1</span>                           
 <span class="comment">3</span>   <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">44</span>.<span class="comment">254/24</span>  <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">44</span>.<span class="comment">0</span>    <span class="comment">ether7
</pre></figure>

<p>RouterOS跟其它的网络设备配置有些区别，IP地址跟物理口的设置分别在两个不同的菜单中，最终在IP地址菜单中实现两者的捆绑。</p>
<h1>DHCP server</h1>
<p>此处仅针对wireless提供DHCP服务。</p>
<figure class="highlight"><pre>[admin<span class="variable">@MikroTik</span>] /ip&gt; dhcp-server <span class="keyword">print</span>
Flags: X - disabled, I - invalid 
 <span class="comment">#   NAME        INTERFACE     RELAY     ADDRESS-POOL        LEASE-TIME ADD-ARP</span>
 <span class="number">0</span>   dhcpServer   wlan1                     dhcp                  <span class="number">3</span>d        
[admin<span class="variable">@MikroTik</span>] /ip&gt; pool <span class="keyword">print</span>
 <span class="comment"># NAME         RANGES                         </span>
 <span class="number">0</span> dhcp         <span class="number">192.168</span>.<span class="number">22.1</span>-<span class="number">192.168</span>.<span class="number">22.10</span>
</pre></figure>

<h1>NAT</h1>
<p>显然，需要为RouterOS中所有网段提供NAT才能正常访问互联网。</p>
<figure class="highlight"><pre><span class="title">[</span><span class="comment">admin@MikroTik</span>] <span class="comment">/ip</span> <span class="comment">firewall</span>&gt; <span class="comment">nat</span> <span class="comment">print</span>
<span class="comment">Flags:</span> <span class="comment">X</span> <span class="literal">-</span> <span class="comment">disabled</span>, <span class="comment">I</span> <span class="literal">-</span> <span class="comment">invalid</span>, <span class="comment">D</span> <span class="literal">-</span> <span class="comment">dynamic</span> 
 <span class="comment">0</span>   <span class="comment">chain=srcnat</span> <span class="comment">action=masquerade</span> <span class="comment">to</span>-<span class="comment">addresses=0</span>.<span class="comment">0</span>.<span class="comment">0</span>.<span class="comment">0</span> <span class="comment">out</span>-<span class="comment">interface=pppoe</span>-<span class="comment">out1
</pre></figure>

<p>NAT配置位于firewall菜单中，其的选项也很复杂，此处的关键是out-interface需要选择<code>pppoe-out1</code>。</p>
<h1>Link Aggregation</h1>
<p>Oracle的文档非常详尽，MikroTik的RouterOS也很简单，因此创建Link Aggregation倒是很(容易)[]。</p>
<p>然而，两者通过两根网线连接后，死活ping不通，我尝试着更换了各种组合，譬如solaris侧分别设置了Policy: L2、L3和L2/L3，LACPactivity: active、passive和off等各种组合，RouterOS中的link monitor也尝试了arp、mii-1等，均未成功。实在没办法，于是只能采用终极大法：升级固件。</p>
<p>升级之后，终于实现Link Aggregation。手工模拟故障，先在RouterOS上ping solaris11的IP地址，拔掉任意一条网线均不影响两者之间的互联，顶多掉一个包。问题得到解决，solaris 11.1最终设置成了：</p>
<figure class="highlight"><pre># dladm <span class="operator"><span class="keyword">show</span>-aggr aggr0
</pre></figure>

<h1>固件升级</h1>
<p>我所买的RB493G的license是Level5，因此可以升级到后续的两个大版本号，比如说现在的RouterOS是V4.16，则最高可以升级到V6。</p>
<p>RouterBOARD的升级非常简单，在winbox界面中，打开file，然后将最新的firmware拖进winbox中，最后在terminal中<code>system reboot</code>重启即可。</p>
<p>自从将Linksys WRT54G换成了RB493G后，一个明显的感觉就是，笔记本通过无线浏览网页的速度比以前快多了，难道是心理作用？</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-04-03T15:00:00.000Z"><a href="/2013/04/03/OpenVPN-on-OpenBSD/">2013-04-3</a></time>
      
      
  
    <h1 class="title"><a href="/2013/04/03/OpenVPN-on-OpenBSD/">OpenVPN on OpenBSD</a></h1>
  

    </header>
    <div class="entry">
      
        <p>2013-04-03添加topology subnet和ccd配置。<br>2013-02-14取消whichsslconf依赖。<br>2012-04-12初稿。<br>{: .info}</p>
<p>OpenVPN是近年来最火的VPN软件，它部署容易，使用简单，跟IPsec相比，它所缺少的只是积累和口碑，不过没关系，已经有越来越多的公司开始在生产环境中用OpenVPN来取代IPsec。<br>
      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2013/04/03/OpenVPN-on-OpenBSD/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-04-01T05:00:00.000Z"><a href="/2013/04/01/some-tips-about-app-migration/">2013-04-1</a></time>
      
      
  
    <h1 class="title"><a href="/2013/04/01/some-tips-about-app-migration/">一次业务迁移的经验小结</a></h1>
  

    </header>
    <div class="entry">
      
        <h2>移动介质的FS要足够普通</h2>
<p>我准备了一块160G的移动硬盘，由于容量比较大，因此格式化为exFAT格式，然而生产环境的OS分别是windows 2003和OpenSUSE11.3，都无法识别，而移动硬盘中还有其它数据，不能直接格式化，因此费了一番心思。</p>
<p>所以，移动介质一定要采用最普通的文件系统，譬如FAT32，windows2003和较老的linux都无法识别exFAT。</p>
<h2>如何实现快速拷贝</h2>
<p>windows ntfs文件系统对付小文件力不从心，因此假如有大量小文件需要备份，有两种解决办法：</p>
<ul>
<li><p>压缩-传输-解压</p>
<p>用winzip、winrar这样的压缩软件采用zip方式打包（不压缩，选择最快速度）小文件后，作为一个打文件传送到另外一个服务器，然后在目的地解压；</p>
</li>
<li><p>使用第三方拷贝软件</p>
<p>譬如fastcopy和ultracopier，千万别用teracopy，在cmoa业务数据备份的过程中发现它有两个问题：</p>
<ol>
<li>拷贝速度不稳定，下跌厉害；</li>
<li>拷贝文件出现错误。而fastcopy就非常稳定，而且不会出错。</li>
</ol>
</li>
</ul>
<p>经测试，采用CIFS/SMB共享方式，fastcopy的拷贝速度可达15MB/s，基本上是千兆网络速率的极限。</p>
<h2>尽量使用域名</h2>
<p>基于B/S架构的业务系统尽量用域名访问，否则IP地址变更后，如何通知几百个客户是非常痛苦的一件事情，尤其是政府客户。</p>
<h2>基础服务和业务应用分开部署</h2>
<p>2009年部署业务应用的时缺乏经验，将一些基础服务，譬如DNS、radius、AD和OpenVPN等基础服务连同业务应用全部部署在同一台物理服务器上，导致业务应用迁移前需先做好基础服务的迁移。当然，假如物理服务器数量足够的话，没有人愿意将多个服务部署在一台服务器。</p>
<h2>VMware中修改guest OS的MAC地址</h2>
<p>很多业务应用的license都跟服务器的MAC地址进行绑定，因此需要提前了解VMware环境中的MAC地址修改技巧。</p>
<p>有两种方式</p>
<ul>
<li><p>修改VMware的VMX文件</p>
</li>
<li><p>修改guest OS中的AMC地址，windows中我经常用的是K-mac，linux则直接在网卡的配置文件中设定即可。</p>
</li>
</ul>
<h2>新不如旧</h2>
<p>前面的文件系统是这样，接下来的无线路由器也是这样，在本次迁移的过程中，顺手用一个D-link DIR600M换掉一台古老的linksys WRT54G。</p>
<p>DIR600M支持AP和无线路由两种无线工作方式，AP方式指的是WAN、LAN和wifi处于同一个网段：192.168.0.0/24，而且这个网段还不能手工改，无线路由方式指的是WAN连接互联网，LAN和wifi处于同一个网段。好在LAN可以自行设置IP地址。因此最终选择了“无线路由”方式。DIR600M仅有4M rom和32M ram，刷OpenWRT就不必了，还比不上两年前买的LinkSYS WRT54G mod，至少还有8M rom和64M ram呢。</p>
<p>所以说，并不是越新就越好，成本的下降往往意味着偷工减料。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-02-21T15:57:00.000Z"><a href="/2013/02/21/seafile-service/">2013-02-21</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/21/seafile-service/">seafile服务</a></h1>
  

    </header>
    <div class="entry">
      
        <p>seafile是一个非常好用的，适合于小团队的文件共享服务软件。同时，它还是一款国内的开源软件，难得可贵。这两天我花了一些时间架设seafile服务，记录下来备用。</p>
<h2>seafile介绍</h2>
<p><em>组件</em></p>
<ul>
<li>ccnet：网络服务</li>
<li>seafile server：负责数据访问</li>
<li>seahub：网站界面，供用户管理自己在服务器上的数据和账户信息</li>
<li>HttpServer: 负责直接从网站上下载和上传文件</li>
<li>controller: 负责监控和重启上述部件</li>
</ul>
<p><em>seafile环境</em></p>
<img src="http://dl.dropbox.com/u/74911209/octopress/2013-02-26_seafile-topology.jpg" class="center " title="seafile组网示意图" alt="seafile组网示意图">


<p>如图示，seafile服务器位于防火墙之后，需要在防火墙做好端口映射。</p>
<blockquote>
<p><strong>NOTE</strong><br>我用的是中国移动的宽带，无法通过官网的下载链接直接下载。必须fanqiang到<a href="https://code.google.com/p/seafile/downloads/list手工下载，然后再通过winscp传送到linux服务器上，颇为费劲。" target="_blank">https://code.google.com/p/seafile/downloads/list手工下载，然后再通过winscp传送到linux服务器上，颇为费劲。</a></p>
</blockquote>
<h2>安装</h2>
<p>服务端支持linux和windows两种操作系统，本文的选择是debian 6 32bit。</p>
<p><strong>准备存储</strong></p>
<p>事先安装好nfs client，然后挂载NFS</p>
<figure class="highlight"><pre><span class="preprocessor"># mkdir -p /mnt/seafile</span>
<span class="preprocessor"># echo "192.168.55.120:/tank/documents/seafile  /mnt/seafile  nfs  defaults  0 1" &gt;&gt; /etc/fstab</span>
<span class="preprocessor"># mount /mnt/seafile</span>
</pre></figure>

<p><strong>准备运行环境</strong></p>
<figure class="highlight"><pre><span class="preprocessor"># aptitude update</span>
<span class="preprocessor"># aptitude install python2.6 python-setuptools python-simplejson python-imaging sqlite3</span>
</pre></figure>

<p><strong>安装</strong></p>
<p>查看系统架构，32bit or 64bit</p>
<pre><code><span class="preprocessor"># uname -m      </span></code></pre>
<p>创建seafile根目录，源文件将解压到该根目录下</p>
<pre><code><span class="preprocessor"># mkdir /usr/local/src/seafile</span>
<span class="preprocessor"># tar -C /usr/local/src/seafile -zxvf seafile-server_1.7.0_i386.tar.gz</span></code></pre>
<p>that&#39;s all.</p>
<h2>配置</h2>
<figure class="highlight"><pre><span class="preprocessor"># cd /usr/local/src/seafile-server-*</span>
<span class="preprocessor"># ./setup-seafile.sh</span>
</pre></figure>

<p>配置参数如下：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>seafile server name</td>
<td>seafile服务器的名字，3~15 个字符，可用英文字母，数字，下划线</td>
</tr>
<tr>
<td>seafile server ip or domain</td>
<td>seafile服务器的IP地址或者域名。客户端将通过这个IP或者域名来访问Seafile服务。需要注意的是，在本例中，该IP地址应设为防火墙的互联网IP</td>
</tr>
<tr>
<td>ccnet server port</td>
<td>默认：10001</td>
</tr>
<tr>
<td>seafile data dir</td>
<td>seafile数据存放目录，默认是./seafile/seafile-data，建议放在一个NFS服务器中，方便日后的扩容和维护。</td>
</tr>
<tr>
<td>seafile server port</td>
<td>seafile服务器使用的TCP端口，默认为12001</td>
</tr>
<tr>
<td>seafile httpserver port</td>
<td>seafile httpserver使用的TCP端口，默认为8082</td>
</tr>
<tr>
<td>seahub admin email</td>
<td>sehaub管理员的帐户。该帐号仅是管理员帐号，用于发送邮件通知的email帐号需在seafile.conf中进行配置。</td>
</tr>
<tr>
<td>seahub admin password</td>
<td>seahub管理员的密码</td>
</tr>
</tbody>
</table>
<p>seafile的配置文件是分布式的，不同组件的配置文件单独分开，不利于维护。</p>
<p><strong>启动</strong></p>
<figure class="highlight"><pre><span class="xml"></span><span class="comment"># ./seafile.sh start</span><span class="xml">
</span><span class="comment"># ./seahub.sh start</span><span class="xml">
假如seahub的端口不是默认的</span><span class="number">8000</span><span class="xml">，则
./seahub.sh start <span class="tag">&lt;<span class="title">new_port</span>&gt;</span></span>
</pre></figure>

<p><strong>停止</strong></p>
<figure class="highlight"><pre><span class="preprocessor"># ./seafile.sh stop</span>
<span class="preprocessor"># ./seahub.sh stop</span>
</pre></figure>

<p><strong>重启</strong></p>
<figure class="highlight"><pre><span class="preprocessor"># ./seafile.sh restart</span>
<span class="preprocessor"># ./seahub.sh restart</span>
</pre></figure>

<p>假如seahub的端口不是默认的8000，则</p>
<figure class="highlight"><pre># ./seahub.sh restart <span class="tag">&lt;<span class="title">new_port</span>&gt;</span>
</pre></figure>

<h1>升级</h1>
<p>由于seafile的开发非常活跃，新版本层出不穷，因而经常需要升级。</p>
<p>升级前需先中止seahub和seafile进程：</p>
<figure class="highlight"><pre><span class="preprocessor"># ./seahub.sh stop</span>
<span class="preprocessor"># ./seafile.sh stop</span>
</pre></figure>

<p>新下载的版本也一并解压到seafile的根目录下，在本文中指的是<code>/usr/local/src/seafile</code>，读者也可以自行选择其它目录。最终的目录结构如下：</p>
<figure class="highlight"><pre><span class="comment">/usr/local/src</span>
   <span class="literal">-</span><span class="literal">-</span> <span class="comment">seafile</span>-<span class="comment">server</span>-<span class="comment">1</span>.<span class="comment">7</span>.<span class="comment">0</span>
   <span class="literal">-</span><span class="literal">-</span> <span class="comment">seafile</span>-<span class="comment">server</span>-<span class="comment">1</span>.<span class="comment">4</span>.<span class="comment">5</span>
   <span class="literal">-</span><span class="literal">-</span> <span class="comment">ccnet</span>
   <span class="literal">-</span><span class="literal">-</span> <span class="comment">seafile</span>-<span class="comment">data
</pre></figure>

<p><strong>小版本升级</strong></p>
<p>指的是从1.6.0升级到1.6.1。</p>
<figure class="highlight"><pre><span class="comment">cd</span> <span class="comment">/usr/local/src/seafile/seafile</span>-<span class="comment">server</span>-<span class="comment">1</span>.<span class="comment">3</span>.<span class="comment">1/seahub/media</span>
<span class="comment">cp</span> <span class="literal">-</span><span class="comment">rf</span> <span class="comment">avatars/*</span> <span class="string">.</span><span class="string">.</span><span class="comment">/</span>.<span class="string">.</span><span class="comment">/</span>.<span class="string">.</span><span class="comment">/seahub</span>-<span class="comment">data/avatars/</span>
<span class="comment">rm</span> <span class="literal">-</span><span class="comment">rf</span> <span class="comment">avatars</span>
<span class="comment">ln</span> <span class="literal">-</span><span class="comment">s</span> <span class="string">.</span><span class="string">.</span><span class="comment">/</span>.<span class="string">.</span><span class="comment">/</span>.<span class="string">.</span><span class="comment">/seahub</span>-<span class="comment">data/avatars
</pre></figure>

<p><strong>连续版本升级</strong></p>
<p>指的是从1.6.0升级到1.7.0。</p>
<figure class="highlight"><pre><span class="title">cd</span> /usr/local/src/seafile-server1.<span class="number">7</span>.<span class="number">0</span>/upgrade
./update_1.6_1.<span class="number">7</span>.sh
</pre></figure>

<p><strong>非连续版本升级</strong></p>
<p>现在的版本为1.4，最新版本为1.7，需连续执行</p>
<figure class="highlight"><pre><span class="comment">cd</span> <span class="comment">/usr/local/src/seafile</span>-<span class="comment">server1</span>.<span class="comment">7</span>.<span class="comment">0/upgrade</span>
<span class="string">.</span><span class="comment">/update_1</span>.<span class="comment">4_1</span>.<span class="comment">5</span>.<span class="comment">sh</span>
<span class="string">.</span><span class="comment">/update_1</span>.<span class="comment">5_1</span>.<span class="comment">6</span>.<span class="comment">sh</span>
<span class="string">.</span><span class="comment">/update_1</span>.<span class="comment">6_1</span>.<span class="comment">7</span>.<span class="comment">sh
</pre></figure>

<p>升级完毕后启动seahub和seafile进程。</p>
<p><strong>随机启动</strong></p>
<p>seafile服务由多个进程共同协作而成，</p>
<p>创建<code>/etc/init.d/seafile-server</code></p>
<figure class="highlight"><pre><span class="shebang">#!/bin/sh</span>
<span class="comment">### BEGIN INIT INFO</span>
<span class="comment"># Provides:		seafile-server</span>
<span class="comment"># Required-Start:	$all</span>
<span class="comment"># Required-Stop:	$all</span>
<span class="comment"># Should-Start:		$local_fs</span>
<span class="comment"># Should-Stop:		$local_fs</span>
<span class="comment"># Default-Start:	2 3 4 5</span>
<span class="comment"># Default-Stop:		0 1 6</span>
<span class="comment">### END INIT INFO</span>

<span class="comment"># Change the value of "user" to your user name</span>
user=root

<span class="comment"># Change the value of "script_path" to your path of seafile installation</span>
script_path=/usr/local/src/seafile/seafile-server-1.7.0

sudo -u <span class="variable">${user}</span> <span class="variable">${script_path}</span>/seafile.sh start &gt; /tmp/seafile.init.log 2&gt;&1
sudo -u <span class="variable">${user}</span> <span class="variable">${script_path}</span>/seahub.sh start &gt; /tmp/seahub.init.log 2&gt;&1
</pre></figure>

<p>以上脚本仅用于start，缺乏stop和restart的功能。</p>
<p>更新</p>
<figure class="highlight"><pre><span class="preprocessor"># chmod +x /etc/init.d/seafile-server</span>
<span class="preprocessor"># update-rc.d seafile-server defaults</span>
</pre></figure>

<h2>tips</h2>
<ul>
<li><p>变更默认端口后，seafile可能会出现问题，这种情况下建议直接重装了事，包括服务端和客户端。</p>
</li>
<li><p>客户端的删除</p>
<ul>
<li>删除客户端之前请确保ccnet进程已杀掉，否则无法正常卸载。</li>
<li>卸载完后，手工删除客户端的配置文件夹<code>C:\用户\&lt;用户名&gt;\ccnet</code></li>
</ul>
</li>
<li><p>客户端的配置</p>
<p>  客户端的配置文件为<code>C:\用户\&lt;用户名&gt;\ccnet\ccnet.conf</code>，假如服务端的变更了默认端口号，需在此进行变更。</p>
</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-12-22T04:30:00.000Z"><a href="/2012/12/22/upgrade-openbsd/">2012-12-22</a></time>
      
      
  
    <h1 class="title"><a href="/2012/12/22/upgrade-openbsd/">升级OpenBSD</a></h1>
  

    </header>
    <div class="entry">
      
        <p>我目前的两台防火墙是OpenBSD4.9，需要升级到5.2。由于OpenBSD不支持跨版本升级，因此需要采用4.9-&gt;5.0-&gt;5.1-&gt;5.2这种逐步升级的方式。</p>
<p>下面步骤是官网推荐的upgrade by install kernel。</p>
<pre><code><span class="preprocessor"># mkdir /backup</span>
<span class="preprocessor"># mv /bsd.rd /backup/bsd.rd.50</span>
<span class="preprocessor"># wget http://ftp.jaist.ac.jp/pub/OpenBSD/5.2/i386/bsd.rd</span>
<span class="preprocessor"># shutdown -r now</span></code></pre>
<p>在boot的提示符中输入</p>
<pre><code>&gt;<span class="filename">bsd.rd</code></pre>
<p>选择<code>(U)pgrade</code>，然后选择合适的sets: <code>bsd.rd</code>,<code>bsd</code>,<code>base.tgz</code>,<code>comp52.tgz</code>,<code>man52.tgz</code></p>
<pre><code><span class="preprocessor"># wget http://ftp.jaist.ac.jp/pub/OpenBSD/5.2/i386/etc52.tgz</span>
<span class="preprocessor"># sysmerge -x /backup/etc52.tgz</span></code></pre>
<p>最后是确认所有的配置文件是否正确</p>
<pre><code><span class="preprocessor"># shutdown -r now</span></code></pre>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-10-03T15:00:00.000Z"><a href="/2012/10/03/use-iscsi-as-vm-storage-backend/">2012-10-3</a></time>
      
      
  
    <h1 class="title"><a href="/2012/10/03/use-iscsi-as-vm-storage-backend/">使用iSCSI作为VM的storage backend</a></h1>
  

    </header>
    <div class="entry">
      
        <p>iSCSI作为VM的storage backend也很流行，原因是iSCSI协议非常适合于小文件的读写，而且其对硬件设备几乎没有什么要求，只要IP可达即可。</p>
<p>在本文中，我们仍然以solaris11作为外置存储，不得不说，solaris11实在是太强悍了，ZFS，comstar，nfs都是存储必备的组件模块。</p>
<h1>iSCSI server</h1>
<p>iSCSI server安装在solaris11上，solaris11</p>
<h1>iSCSI client</h1>
<p>iSCSI client将安装在hypervisor上，本文以CentOS为例。</p>
<h2>安装iSCSI client</h2>
<p>[root@DL165-1 ~]# yum install iscsi-initiator-utils</p>
<h2>配置iSCSI client</h2>
<figure class="highlight"><pre>[root@DL165-<span class="number">1</span> ~]<span class="comment"># vim /etc/iscsi/iscsid.conf</span>
<span class="keyword">...</span>
node.session.auth.username = linuxabc
node.session.auth.password = <span class="number">123456</span>
discovery.sendtargets.auth.username = linuxabc
discovery.sendtargets.auth.password = <span class="number">123456</span>
<span class="keyword">...</span>
</pre></figure>

<h2>启动iSCSI服务</h2>
<figure class="highlight"><pre>[root<span class="variable">@DL165</span>-<span class="number">1</span> ~]<span class="comment"># /etc/init.d/iscsi start</span>
</pre></figure>

<h2>连接到iSCSI server</h2>
<figure class="highlight"><pre><span class="title">[</span><span class="comment">root@DL165</span>-<span class="comment">1</span> <span class="comment">~</span>]<span class="comment">#</span> <span class="comment">iscsiadm</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">discovery</span> <span class="literal">-</span><span class="comment">t</span> <span class="comment">sendtargets</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">192</span>.<span class="comment">168</span>.<span class="comment">55</span>.<span class="comment">120</span>
<span class="title">[</span><span class="comment">root@DL165</span>-<span class="comment">1</span> <span class="comment">~</span>]<span class="comment">#</span> <span class="comment">iscsiadm</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">node</span> <span class="literal">-</span><span class="comment">T</span> <span class="comment">iqn</span>.<span class="comment">2010</span>-<span class="comment">06</span>.<span class="comment">xen</span>-<span class="comment">sanhead:xen</span>-<span class="comment">alfie</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">login</span>
<span class="title">[</span><span class="comment">root@DL165</span>-<span class="comment">1</span> <span class="comment">~</span>]<span class="comment">#</span> <span class="comment">/etc/init</span>.<span class="comment">d/iscsi</span> <span class="comment">restart
</pre></figure>

<p>在xen dom0中执行<code>fdisk -l</code>就会看到系统中多出了一个块设备/dev/sdc，那正是ZFS storage上的iSCSI target。</p>
<figure class="highlight"><pre>[root@DL165-<span class="number">1</span> ~]<span class="comment"># fdisk -l</span>
<span class="keyword">...</span>
Disk /dev/sdc: <span class="number">8589</span> MB, <span class="number">8589934592</span> bytes
<span class="number">64</span> heads, <span class="number">32</span> sectors/track, <span class="number">8192</span> cylinders
Units = cylinders of <span class="number">2048</span> * <span class="number">512</span> = <span class="number">1048576</span> bytes

Disk /dev/sdc doesn<span class="string">'t contain a valid partition table
</pre></figure>

<p>最后在xen dom0机器上把domU配置文件的disk一行改成：</p>
<figure class="highlight"><pre><span class="setting">disk = <span class="value">[ <span class="string">"phy:/dev/sdc,xvda,w"</span> ]</span></span>
</pre></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-10-02T15:00:00.000Z"><a href="/2012/10/02/upgrade-xen-and-centos/">2012-10-2</a></time>
      
      
  
    <h1 class="title"><a href="/2012/10/02/upgrade-xen-and-centos/">CentOS5.6+xen3.4.3升级至CentOS5.8+xen3.4.4</a></h1>
  

    </header>
    <div class="entry">
      
        <p>去年使用gitco repos成功地在CentOS5.6上安装了xen 3.4.3，已经稳定地运行了一年。前段时间CentOS和xen都升级了，于是便有了下文。</p>
<h2>升级CentOS</h2>
<p>在升级之前为了稳妥起见，先备份相关的配置文件。</p>
<p>CentOS的升级很简单，就是<code>yum update</code>，然后重启，唯一需要注意的就是重启前需要调整<code>/boot/grub/menu.lst</code>中的启动顺序，因为升级后，CentOS默认的内核启动顺序是新版的kernel。</p>
<p>验证一下</p>
<figure class="highlight"><pre>[root<span class="variable">@DL165</span>-<span class="number">2</span> ~]<span class="comment"># cat /etc/redhat-release </span>
<span class="constant">CentOS</span> release <span class="number">5.8</span> (<span class="constant">Final</span>)
</pre></figure>

<h2>升级xen</h2>
<figure class="highlight"><pre>[root<span class="variable">@DL165</span>-<span class="number">2</span> ~]<span class="comment"># mv /etc/yum.repos.d/GITCO-xen3.4.3 backup</span>
[root<span class="variable">@DL165</span>-<span class="number">2</span> ~]<span class="comment"># wget http://www.gitco.de/xen3.4.4</span>
[root<span class="variable">@DL165</span>-<span class="number">2</span> ~]<span class="comment"># yum update xen</span>
</pre></figure>

<p>将从xen3.4.3升级至xen3.4.4，验证一下：</p>
<figure class="highlight"><pre>[root@<span class="type">DL165</span>-<span class="number">2</span> ~]# xm info
<span class="title">host</span>                   : <span class="type">DL165</span>-<span class="number">2</span>
<span class="title">release</span>                : <span class="number">2.6</span><span class="number">.18</span>-<span class="number">308.13</span><span class="number">.1</span>.el5xen
<span class="title">version</span>                : #<span class="number">1</span> <span class="type">SMP</span> <span class="type">Tue</span> <span class="type">Aug</span> <span class="number">21</span> <span class="number">17</span>:<span class="number">51</span>:<span class="number">21</span> <span class="type">EDT</span> <span class="number">2012</span>
<span class="title">machine</span>                : x86_64
<span class="title">nr_cpus</span>                : <span class="number">8</span>
<span class="title">nr_nodes</span>               : <span class="number">1</span>
<span class="title">cores_per_socket</span>       : <span class="number">4</span>
<span class="title">threads_per_core</span>       : <span class="number">1</span>
<span class="title">cpu_mhz</span>                : <span class="number">2693</span>
<span class="title">hw_caps</span>                : <span class="number">178</span>bf3ff:efd3fbff:<span class="number">00000000</span>:<span class="number">00000310</span>:<span class="number">00802001</span>:<span class="number">00000000</span>:<span class="number">000037</span>ff:<span class="number">00000000</span>
<span class="title">virt_caps</span>              : hvm
<span class="title">total_memory</span>           : <span class="number">8191</span>
<span class="title">free_memory</span>            : <span class="number">7579</span>
<span class="title">node_to_cpu</span>            : node0:<span class="number">0</span>-<span class="number">7</span>
<span class="title">node_to_memory</span>         : node0:<span class="number">7579</span>
<span class="title">xen_major</span>              : <span class="number">3</span>
<span class="title">xen_minor</span>              : <span class="number">4</span>
<span class="title">xen_extra</span>              : <span class="number">.4</span>
<span class="title">xen_caps</span>               : xen-<span class="number">3.0</span>-x86_64 xen-<span class="number">3.0</span>-x86_32p hvm-<span class="number">3.0</span>-x86_32 hvm-<span class="number">3.0</span>-x86_32p hvm-<span class="number">3.0</span>-x86_64 
<span class="title">xen_scheduler</span>          : credit
<span class="title">xen_pagesize</span>           : <span class="number">4096</span>
<span class="title">platform_params</span>        : virt_start=<span class="number">0xffff800000000000</span>
<span class="title">xen_changeset</span>          : unavailable
<span class="title">cc_compiler</span>            : gcc version <span class="number">4.1</span><span class="number">.2</span> <span class="number">20080704</span> (<span class="type">Red</span> <span class="type">Hat</span> <span class="number">4.1</span><span class="number">.2</span>-<span class="number">52</span>)
<span class="title">cc_compile_by</span>          : root
<span class="title">cc_compile_domain</span>      : gitco.tld
<span class="title">cc_compile_date</span>        : <span class="type">Mon</span> <span class="type">Jun</span> <span class="number">25</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">36</span> <span class="type">CEST</span> <span class="number">2012</span>

<span class="title">xend_config_format</span>     : <span class="number">4</span>
</pre></figure>


      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
  
    <a href="/page/2/" class="alignright next">Next</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:ioiioi.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/RouterOS/MikroTik/">MikroTik</a><small>2</small></li>
  
    <li><a href="/categories/RouterOS/">RouterOS</a><small>4</small></li>
  
    <li><a href="/categories/VPS/">VPS</a><small>1</small></li>
  
    <li><a href="/categories/confluence/">confluence</a><small>1</small></li>
  
    <li><a href="/categories/ldap/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/debian/">debian</a><small>13</small></li>
  
    <li><a href="/categories/dhcp/debian/">debian</a><small>1</small></li>
  
    <li><a href="/categories/dhcp/">dhcp</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/">domU</a><small>1</small></li>
  
    <li><a href="/categories/freebsd/">freebsd</a><small>1</small></li>
  
    <li><a href="/categories/iptable/">iptable</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/iscsi/">iscsi</a><small>1</small></li>
  
    <li><a href="/categories/kvm/">kvm</a><small>1</small></li>
  
    <li><a href="/categories/network/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/ldap/">ldap</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/linksys/">linksys</a><small>1</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/">netbsd</a><small>1</small></li>
  
    <li><a href="/categories/openbsd/netmgmt/">netmgmt</a><small>1</small></li>
  
    <li><a href="/categories/debian/network/">network</a><small>2</small></li>
  
    <li><a href="/categories/network/">network</a><small>3</small></li>
  
    <li><a href="/categories/networking/">networking</a><small>1</small></li>
  
    <li><a href="/categories/nexenta/">nexenta</a><small>4</small></li>
  
    <li><a href="/categories/octopress/">octopress</a><small>3</small></li>
  
    <li><a href="/categories/debian/octopress/">octopress</a><small>2</small></li>
  
    <li><a href="/categories/openSUSE/">openSUSE</a><small>2</small></li>
  
    <li><a href="/categories/openbsd/">openbsd</a><small>7</small></li>
  
    <li><a href="/categories/openbsd openntpd/">openbsd openntpd</a><small>1</small></li>
  
    <li><a href="/categories/openwrt/">openwrt</a><small>2</small></li>
  
    <li><a href="/categories/others/">others</a><small>1</small></li>
  
    <li><a href="/categories/seafile/">seafile</a><small>1</small></li>
  
    <li><a href="/categories/seafile/services/">services</a><small>1</small></li>
  
    <li><a href="/categories/linux/netbsd/solaris/">solaris</a><small>1</small></li>
  
    <li><a href="/categories/tech/">tech</a><small>1</small></li>
  
    <li><a href="/categories/tech/tips/">tips</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/">ubuntu</a><small>1</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>1</small></li>
  
    <li><a href="/categories/debian/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/windows/virtualbox/">virtualbox</a><small>1</small></li>
  
    <li><a href="/categories/virtualbox/">virtualbox</a><small>4</small></li>
  
    <li><a href="/categories/kvm/virtualization/">virtualization</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/">virtualization</a><small>2</small></li>
  
    <li><a href="/categories/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/categories/windows/">windows</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/debian/domU/xen/">xen</a><small>1</small></li>
  
    <li><a href="/categories/ubuntu/domU/xen/">xen</a><small>1</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 alfie chan
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>